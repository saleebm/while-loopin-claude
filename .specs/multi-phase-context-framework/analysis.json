{
  "feature_name": "multi-phase-context-framework",
  "prompt_type": "Framework Enhancement - Adding context file tracking and master agent orchestration to existing agent system",
  "complexity": 8,
  "max_iterations": 15,
  "enable_code_review": true,
  "max_reviews": 5,
  "relevant_files": [
    "lib/agent-runner.sh",
    "lib/claude-functions.sh",
    "lib/smart-agent.sh",
    "lib/context-functions.sh",
    "lib/handoff-functions.sh",
    "lib/code-review.sh",
    "templates/context-template.md",
    "CLAUDE.md",
    "ARCHITECTURE.md"
  ],
  "enhanced_prompt": "# Multi-Phase Context Framework Implementation\n\n## Mission\nImplement a comprehensive context management framework that enforces agents to maintain context files tracking their work, and add a master agent system for coordinating multi-phase agent execution.\n\n## Current State Analysis\nThe codebase already includes:\n- `context-functions.sh` with full context file management utilities\n- Functions for creating, updating, and validating context files\n- Template structures for instructions, progress, findings, and achievements\n- Path sanitization and security measures\n\n## Implementation Tasks\n\n### Phase 1: Context File Integration (Already Partially Complete)\n- Context file functions already exist in `lib/context-functions.sh`\n- Need to integrate context file updates into the main agent loop in `agent-runner.sh`\n- Add instruction to agent prompts to use context files\n- Ensure context files are created/updated each iteration\n\n### Phase 2: Master Agent Framework\n- Create master agent orchestrator script\n- Implement phase detection and switching logic\n- Create planning agent interface\n- Add phase coordination utilities\n\n### Phase 3: Integration\n- Integrate context updates into existing agent loop\n- Add master agent mode detection\n- Update feature directory patterns\n- Ensure backward compatibility\n\n### Phase 4: Prompt Engineering\n- Update agent prompt templates to include context instructions\n- Create specialized prompts for master and phase agents\n- Add context awareness to existing prompts\n\n## Critical Constraints\n1. **PRESERVE ALL EXISTING FUNCTIONALITY** - Zero regressions allowed\n2. **BUILD ON EXISTING PATTERNS** - Use existing functions like `run_claude()`, `ensure_context_files()`\n3. **MINIMAL MODIFICATIONS** - Only add code, don't change core logic unnecessarily\n4. **MAINTAIN SIMPLICITY** - Avoid over-engineering\n5. **ENSURE COMPOSABILITY** - Functions must be reusable\n\n## Context File Requirements\n- Location: `.specs/{feature-name}/context/`\n- Files: instructions.md, progress.md, findings.md, achievements.md\n- Must be updated every iteration\n- Must include validation proof in achievements\n\n## Master Agent Requirements\n- Coordinate multi-phase execution\n- Operate alongside main agent\n- Control sub-agents based on planning output\n- Planning agent separate from main agent\n\n## First Actions\n1. Verify existing context functions work correctly\n2. Add context file update instruction to agent loop\n3. Test with simple agent run\n4. Begin master agent framework design\n\n## Success Validation\n- Context files automatically created and populated\n- Agent loop continues to function normally\n- Master agent can coordinate phases\n- All existing tests pass\n- Pattern reusable across feature directories",
  "initial_handoff": "# Agent Handoff\n\n## Session End\nStatus: starting\n\n## Current State\n- Context functions already implemented in `lib/context-functions.sh`\n- Functions include: ensure_context_files(), init_context_file(), update_context_timestamp()\n- Need to integrate into main agent loop\n- Master agent framework not yet started\n\n## Next Steps\n1. Add context file update instruction to agent runner prompt\n2. Test context file creation and updates\n3. Design master agent orchestration structure\n4. Implement phase coordination logic\n5. Create planning agent interface\n\n## Findings\n- Context management utilities already exist and are well-structured\n- Path sanitization and security measures in place\n- Template files for all context types already defined\n- Integration point needed in run_claude_agent() function\n\n## Investigation Notes\n- context-functions.sh provides complete context management API\n- Functions handle directory creation, file initialization, and updates\n- Security measures include path traversal protection\n- Timestamp updates already implemented",
  "reasoning": "This is a complex framework enhancement requiring careful integration with existing shell scripts. The context functions are already implemented, suggesting Phase 1 is partially complete. The main work involves integrating these functions into the agent loop and building the master agent coordination system. High complexity due to multi-phase nature and need to preserve all existing functionality. Requires 15 iterations to handle all phases carefully with testing."
}
